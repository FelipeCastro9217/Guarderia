@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@{
    ViewData["Title"] = "Gráficos por Parámetros";
}

<div class="container mt-4">
    <h2><i class="bi bi-bar-chart-fill"></i> @ViewData["Title"]</h2>
    <hr />

    <!-- Panel de Configuración -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5><i class="bi bi-sliders"></i> Configuración de Gráfico</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label">Tipo de Gráfico *</label>
                    <select id="tipoGrafico" class="form-select">
                        <option value="">-- Seleccione un tipo --</option>
                        <option value="servicios_stock">Stock de Servicios</option>
                        <option value="ventas_periodo">Ventas por Período</option>
                        <option value="categorias_stock">Stock por Categoría</option>
                        <option value="servicios_vendidos">Servicios Más Vendidos</option>
                        <option value="cuidadores_servicios">Cuidadores - Servicios Asignados</option>
                        <option value="movimientos_tipo">Movimientos por Tipo</option>
                        <option value="ventas_mensuales">Ventas Mensuales (Año Actual)</option>
                    </select>
                </div>

                <div class="col-md-2 mb-3">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" id="fechaInicio" class="form-control" />
                    <small class="text-muted">Opcional</small>
                </div>

                <div class="col-md-2 mb-3">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" id="fechaFin" class="form-control" />
                    <small class="text-muted">Opcional</small>
                </div>

                <div class="col-md-3 mb-3">
                    <label class="form-label">Categoría</label>
                    <select id="categoria" class="form-select">
                        <option value="">Todas las categorías</option>
                        <option value="Baño">Baño</option>
                        <option value="Hospedaje">Hospedaje</option>
                        <option value="Paseo">Paseo</option>
                        <option value="Veterinario">Veterinario</option>
                        <option value="Estética">Estética</option>
                    </select>
                    <small class="text-muted">Para filtrar servicios</small>
                </div>

                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button type="button" id="btnGenerar" class="btn btn-primary w-100">
                        <i class="bi bi-graph-up"></i> Generar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensaje de Ayuda -->
    <div class="alert alert-info" role="alert" id="mensajeAyuda">
        <i class="bi bi-info-circle"></i>
        <strong>Instrucciones:</strong> Seleccione un tipo de gráfico y haga clic en "Generar" para visualizarlo.
        Puede aplicar filtros opcionales de fecha y categoría según el tipo de gráfico seleccionado.
    </div>

    <!-- Gráfico Dinámico Único -->
    <div class="card mb-4" id="graficoContainer" style="display:none;">
        <div class="card-header bg-gradient text-white" id="headerGrafico">
            <h5 id="tituloGrafico"><i class="bi bi-graph-up"></i> Gráfico</h5>
        </div>
        <div class="card-body">
            <canvas id="chartPrincipal" style="height: 400px;"></canvas>
        </div>
        <div class="card-footer text-muted" id="infoGrafico">
            <small><i class="bi bi-calendar"></i> Generado el: <span id="fechaGeneracion"></span></small>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var chartActual = null;

        // Paleta de colores moderna y vibrante
        const coloresModernos = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe',
            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
            '#a8edea', '#fed6e3', '#c471f5', '#12c2e9',
            '#f64f59', '#c471ed', '#38ef7d', '#667eea'
        ];

        const coloresBordes = coloresModernos.map(() => '#2d3748');

        $('#btnGenerar').click(function() {
            var tipoGrafico = $('#tipoGrafico').val();
            var fechaInicio = $('#fechaInicio').val();
            var fechaFin = $('#fechaFin').val();
            var categoria = $('#categoria').val();

            if (!tipoGrafico) {
                alert('Por favor seleccione un tipo de gráfico');
                return;
            }

            // Mostrar loading
            $('#mensajeAyuda').html('<i class="bi bi-hourglass-split"></i> Generando gráfico...').show();

            $.ajax({
                url: '@Url.Action("GenerarGrafico", "Graficos")',
                type: 'POST',
                data: {
                    tipoGrafico: tipoGrafico,
                    fechaInicio: fechaInicio,
                    fechaFin: fechaFin,
                    categoria: categoria
                },
                success: function(data) {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        $('#mensajeAyuda').html('<i class="bi bi-exclamation-triangle"></i> Error al generar el gráfico: ' + data.error);
                        return;
                    }

                    if (!data || data.length === 0) {
                        alert('No hay datos disponibles para mostrar con los filtros seleccionados');
                        $('#mensajeAyuda').html('<i class="bi bi-exclamation-circle"></i> No hay datos disponibles para los filtros seleccionados.');
                        $('#graficoContainer').hide();
                        return;
                    }

                    // Destruir gráfico anterior si existe
                    if (chartActual) {
                        chartActual.destroy();
                    }

                    // Ocultar mensaje de ayuda y mostrar gráfico
                    $('#mensajeAyuda').hide();
                    $('#graficoContainer').show();

                    // Actualizar fecha de generación
                    var ahora = new Date();
                    $('#fechaGeneracion').text(ahora.toLocaleString('es-CO'));

                    // Generar el gráfico
                    var ctx = document.getElementById('chartPrincipal').getContext('2d');
                    var config = generarConfiguracion(tipoGrafico, data);
                    chartActual = new Chart(ctx, config);
                },
                error: function(xhr, status, error) {
                    alert('Error al comunicarse con el servidor: ' + error);
                    $('#mensajeAyuda').html('<i class="bi bi-exclamation-triangle"></i> Error de comunicación con el servidor.');
                }
            });
        });

        function generarConfiguracion(tipo, data) {
            var config = {
                type: 'bar', // TODOS serán gráficos de barras
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            cornerRadius: 8
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            };

            switch(tipo) {
                case 'servicios_stock':
                    $('#tituloGrafico').html('<i class="bi bi-box-seam"></i> Stock de Servicios');
                    $('#headerGrafico').removeClass().addClass('card-header bg-success text-white');
                    config.data = {
                        labels: data.map(d => d.nombreServicio),
                        datasets: [{
                            label: 'Stock Disponible',
                            data: data.map(d => d.stockDisponible),
                            backgroundColor: coloresModernos.slice(0, data.length),
                            borderColor: coloresBordes.slice(0, data.length),
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 50
                        }]
                    };
                    config.options.scales.y.title = {
                        display: true,
                        text: 'Cantidad en Stock',
                        font: { size: 14, weight: 'bold' }
                    };
                    break;

                case 'ventas_periodo':
                    $('#tituloGrafico').html('<i class="bi bi-graph-up"></i> Ventas por Período');
                    $('#headerGrafico').removeClass().addClass('card-header bg-primary text-white');
                    config.data = {
                        labels: data.map(d => d.fecha),
                        datasets: [{
                            label: 'Total Ventas ($)',
                            data: data.map(d => d.total),
                            backgroundColor: '#667eea',
                            borderColor: '#2d3748',
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 40
                        }]
                    };
                    config.options.scales.y.title = {
                        display: true,
                        text: 'Total en Pesos ($)',
                        font: { size: 14, weight: 'bold' }
                    };
                    break;

                case 'categorias_stock':
                    $('#tituloGrafico').html('<i class="bi bi-pie-chart"></i> Stock por Categoría');
                    $('#headerGrafico').removeClass().addClass('card-header bg-info text-white');
                    config.data = {
                        labels: data.map(d => d.categoria),
                        datasets: [{
                            label: 'Stock por Categoría',
                            data: data.map(d => d.stock),
                            backgroundColor: coloresModernos.slice(0, data.length),
                            borderColor: coloresBordes.slice(0, data.length),
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 60
                        }]
                    };
                    config.options.scales.y.title = {
                        display: true,
                        text: 'Cantidad Total',
                        font: { size: 14, weight: 'bold' }
                    };
                    break;

                case 'servicios_vendidos':
                    $('#tituloGrafico').html('<i class="bi bi-star"></i> Servicios Más Vendidos');
                    $('#headerGrafico').removeClass().addClass('card-header bg-danger text-white');
                    config.data = {
                        labels: data.map(d => d.servicio),
                        datasets: [{
                            label: 'Cantidad Vendida',
                            data: data.map(d => d.cantidad),
                            backgroundColor: coloresModernos.slice(0, data.length),
                            borderColor: coloresBordes.slice(0, data.length),
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 45
                        }]
                    };
                    config.options.indexAxis = 'y'; // Barras horizontales
                    config.options.scales.x.title = {
                        display: true,
                        text: 'Cantidad Vendida',
                        font: { size: 14, weight: 'bold' }
                    };
                    config.options.scales.y.title = { display: false };
                    break;

                case 'cuidadores_servicios':
                    $('#tituloGrafico').html('<i class="bi bi-person-badge"></i> Cuidadores - Servicios Asignados');
                    $('#headerGrafico').removeClass().addClass('card-header bg-warning');
                    config.data = {
                        labels: data.map(d => d.cuidador),
                        datasets: [{
                            label: 'Servicios Asignados',
                            data: data.map(d => d.totalServicios),
                            backgroundColor: '#f093fb',
                            borderColor: '#2d3748',
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 50
                        }]
                    };
                    config.options.scales.y.title = {
                        display: true,
                        text: 'Cantidad de Servicios',
                        font: { size: 14, weight: 'bold' }
                    };
                    break;

                case 'movimientos_tipo':
                    $('#tituloGrafico').html('<i class="bi bi-arrow-left-right"></i> Movimientos por Tipo');
                    $('#headerGrafico').removeClass().addClass('card-header bg-secondary text-white');
                    config.data = {
                        labels: data.map(d => d.tipo),
                        datasets: [{
                            label: 'Cantidad de Movimientos',
                            data: data.map(d => d.cantidad),
                            backgroundColor: ['#43e97b', '#fa709a'],
                            borderColor: ['#2d3748', '#2d3748'],
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 80
                        }]
                    };
                    config.options.scales.y.title = {
                        display: true,
                        text: 'Cantidad',
                        font: { size: 14, weight: 'bold' }
                    };
                    break;

                case 'ventas_mensuales':
                    $('#tituloGrafico').html('<i class="bi bi-calendar-month"></i> Ventas Mensuales ' + new Date().getFullYear());
                    $('#headerGrafico').removeClass().addClass('card-header bg-dark text-white');
                    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    config.data = {
                        labels: data.map(d => meses[d.mes - 1]),
                        datasets: [{
                            label: 'Total Ventas ($)',
                            data: data.map(d => d.total),
                            backgroundColor: '#764ba2',
                            borderColor: '#2d3748',
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 40
                        }]
                    };
                    config.options.scales.y.title = {
                        display: true,
                        text: 'Total en Pesos ($)',
                        font: { size: 14, weight: 'bold' }
                    };
                    break;
            }

            return config;
        }

        // Permitir regenerar gráfico al cambiar tipo
        $('#tipoGrafico').change(function() {
            $('#mensajeAyuda').show().html('<i class="bi bi-info-circle"></i> Haga clic en "Generar" para visualizar el gráfico seleccionado.');
        });
    </script>
}